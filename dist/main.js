(()=>{"use strict";const t=function(t,i,e){this.image=new Image,this.image.src=t,this.width=i,this.height=e};function i(i,e,h){this.x=i,this.y=e,this.direction=h,this.weapon=new t("assets/knife_hand.png",319,320),this.paces=0}i.prototype.rotate=function(t){this.direction=(this.direction+t+e)%e},i.prototype.walk=function(t,i){var e=Math.cos(this.direction)*t,h=Math.sin(this.direction)*t;let s=i.get(this.x+e,this.y),n=i.get(this.x,this.y+h);s.height<=0&&(this.x+=e),n.height<=0&&(this.y+=h),this.paces+=t},i.prototype.update=function(t,i,e){t.left&&this.rotate(-Math.PI*e),t.right&&this.rotate(Math.PI*e),t.forward&&this.walk(3*e,i),t.backward&&this.walk(-3*e,i)};const e=2*Math.PI,h=i,s="floor";function n(t,i,e=null){this.type=t,this.height=i,e&&(this.texture=e)}const a={concrete:new t("assets/wall_texture.jpg",1024,1024),brick:new t("assets/brick_wall_2.jpg",1024,1024)},o=new n("null",-1);function r(i){this.size=i,this.wallGrid=new Array(i*i),this.skybox=new t("assets/deathvalley_panorama.jpg",2e3,750),this.wallTexture=new t("assets/wall_texture.jpg",1024,1024),this.light=0}r.prototype.get=function(t,i){return t=Math.floor(t),i=Math.floor(i),t<0||t>this.size-1||i<0||i>this.size-1?o:this.wallGrid[i*this.size+t]},r.prototype.randomize=function(){this.wallGrid[0]=new n(s,0);for(let t=1;t<this.size*this.size;t++){let i;if(Math.random()<.3){i=new n("wall",1,Math.random()<.5?a.concrete:a.brick)}else i=new n(s,0);this.wallGrid[t]=i}},r.prototype.cast=function(t,i,e){var h=this,s=Math.sin(i),n=Math.cos(i),a={length2:1/0};return function t(i){var h=o(s,n,i.x,i.y),a=o(n,s,i.y,i.x,!0),l=h.length2<a.length2?r(h,1,0,i.distance,h.y):r(a,0,1,i.distance,a.x);return l.distance>e?[i]:[i].concat(t(l))}({x:t.x,y:t.y,height:0,distance:0});function o(t,i,e,h,s){if(0===i)return a;var n=i>0?Math.floor(e+1)-e:Math.ceil(e-1)-e,o=n*(t/i);return{x:s?h+o:e+n,y:s?e+n:h+o,length2:n*n+o*o}}function r(t,i,e,a,o){var r=n<0?i:0,l=s<0?e:0;let c=h.get(t.x-r,t.y-l);return t.height=c.height,t.texture=c.texture,t.distance=a+Math.sqrt(t.length2),t.shading=i?n<0?2:0:s<0?2:1,t.offset=o-Math.floor(o),t}},r.prototype.update=function(t){this.light>0?this.light=Math.max(this.light-9*t,0):5*Math.random()<t&&(console.log("lighting crash"),this.light=2)};const l=r,c=/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent),d=2*Math.PI;function g(t,i,e){this.ctx=t.getContext("2d"),this.width=t.width=.5*window.innerWidth,this.height=t.height=.5*window.innerHeight,this.resolution=i,this.spacing=this.width/i,this.focalLength=e||.8,this.range=c?8:14,this.lightRange=5,this.scale=(this.width+this.height)/1200}g.prototype.render=function(t,i){this.drawSky(t.direction,i.skybox,i.light),this.drawColumns(t,i),this.drawWeapon(t.weapon,t.paces)},g.prototype.drawSky=function(t,i,e){var h=i.width*(this.height/i.height)*2,s=t/d*-h;this.ctx.save(),this.ctx.drawImage(i.image,s,0,h,this.height),s<h-this.width&&this.ctx.drawImage(i.image,s+h,0,h,this.height),e>0&&(this.ctx.fillStyle="#ffffff",this.ctx.globalAlpha=.1*e,this.ctx.fillRect(0,.5*this.height,this.width,.5*this.height)),this.ctx.restore()},g.prototype.drawColumns=function(t,i){this.ctx.save();for(var e=0;e<this.resolution;e++){var h=e/this.resolution-.5,s=Math.atan2(h,this.focalLength),n=i.cast(t,t.direction+s,this.range);this.drawColumn(e,n,s,i)}this.ctx.restore()},g.prototype.drawWeapon=function(t,i){var e=Math.cos(2*i)*this.scale*6,h=Math.sin(4*i)*this.scale*6,s=.66*this.width+e,n=.6*this.height+h;this.ctx.drawImage(t.image,s,n,t.width*this.scale,t.height*this.scale)},g.prototype.drawColumn=function(t,i,e,h){for(var s=this.ctx,n=Math.floor(t*this.spacing),a=Math.ceil(this.spacing),o=-1;++o<i.length&&i[o].height<=0;);for(var r=i.length-1;r>=0;r--){let t=i[r].texture?i[r].texture:h.wallTexture;var l=i[r],c=Math.pow(Math.random(),3)*r,d=c>0&&this.project(.1,e,l.distance);if(r===o){var g=Math.floor(t.width*l.offset),p=this.project(l.height,e,l.distance);s.globalAlpha=1,s.drawImage(t.image,g,0,1,t.height,n,p.top,a,p.height),s.fillStyle="#000000",s.globalAlpha=Math.max((l.distance+l.shading)/this.lightRange-h.light,0),s.fillRect(n,p.top,a,p.height)}for(s.fillStyle="#ffffff",s.globalAlpha=.15;--c>0;)s.fillRect(n,Math.random()*d.top,1,d.height)}},g.prototype.project=function(t,i,e){var h=e*Math.cos(i),s=this.height*t/h;return{top:this.height/2*(1+1/h)-s,height:s}},g.prototype.resize=function(){this.width=canvas.width=.5*window.innerWidth,this.height=canvas.height=.5*window.innerHeight,this.spacing=this.width/resolution,this.scale=(this.width+this.height)/1200};const p=g;function f(){this.codes={37:"left",39:"right",38:"forward",40:"backward"},this.states={left:!1,right:!1,forward:!1,backward:!1},document.addEventListener("keydown",this.onKey.bind(this,!0),!1),document.addEventListener("keyup",this.onKey.bind(this,!1),!1),document.addEventListener("touchstart",this.onTouch.bind(this),!1),document.addEventListener("touchmove",this.onTouch.bind(this),!1),document.addEventListener("touchend",this.onTouchEnd.bind(this),!1)}f.prototype.onTouch=function(t){var i=t.touches[0];this.onTouchEnd(t),i.pageY<.5*window.innerHeight?this.onKey(!0,{keyCode:38}):i.pageX<.5*window.innerWidth?this.onKey(!0,{keyCode:37}):i.pageY>.5*window.innerWidth&&this.onKey(!0,{keyCode:39})},f.prototype.onTouchEnd=function(t){this.states={left:!1,right:!1,forward:!1,backward:!1},t.preventDefault(),t.stopPropagation()},f.prototype.onKey=function(t,i){var e=this.codes[i.keyCode];void 0!==e&&(this.states[e]=t,i.preventDefault&&i.preventDefault(),i.stopPropagation&&i.stopPropagation())};const u=f;function w(t,i,e=4){this.ctx=t.getContext("2d"),this.multiplier=e,this.size=i.size*this.multiplier,this.mapX=t.width-this.size-10,this.mapY=10,console.log(this.mapX,this.mapY)}w.prototype.render=function(t,i){this.ctx.save(),this.ctx.fillStyle="rgba(0,0,0, .5)",this.ctx.fillRect(this.mapX,this.mapY,this.size,this.size),this.ctx.save(),this.ctx.fillStyle="rgba(255,255,255, .5)";for(let t=0;t<i.size;t++)for(let e=0;e<i.size;e++){let h=t*i.size+e;i.wallGrid[h].height>0&&this.ctx.fillRect(this.mapX+this.multiplier*e,this.mapY+this.multiplier*t,this.multiplier,this.multiplier)}this.ctx.fillStyle="rgb(0,255,0)",this.ctx.fillRect(t.x*this.multiplier+this.mapX-1,t.y*this.multiplier+this.mapY-1,2,2),this.ctx.restore()};const m=w;Math.PI;var y=/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);function x(){this.frame=this.frame.bind(this),this.lastTime=0,this.callback=function(){}}x.prototype.start=function(t){this.callback=t,requestAnimationFrame(this.frame)},x.prototype.frame=function(t){var i=(t-this.lastTime)/1e3;this.lastTime=t,i<.2&&this.callback(i),requestAnimationFrame(this.frame)};var v=document.getElementById("display"),M=new h(0,0,.3*Math.PI),b=new l(32),k=new u,z=new p(v,y?160:320,.8),P=new x;let I=new m(v,b,y?1:5);b.randomize(),P.start((t=>{b.update(t),M.update(k.states,b,t),z.render(M,b),I.render(M,b)})),window.onresize=()=>{z.resize()}})();